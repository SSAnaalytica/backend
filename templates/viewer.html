<!DOCTYPE html>
<html>
<head>
    <title>Visor WSI - {{slide}}</title>
    <meta charset="UTF-8">
    <link rel="icon" href="/assets/logo_santa_sofia.png">
    <link rel="stylesheet" href="/assets/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/openseadragon.min.js"></script>
    <style>
        .main-container { display: flex; position: relative; }
        .left-panel {
            width: 250px; padding: 10px; background: #f7f9fb; border-right: 1px solid #ccc;
        }
        .right-panel {
            width: 300px; padding: 15px; background: #f7f9fb; transition: all 0.3s ease;
        }
        .right-panel.collapsed { width: 0; padding: 0; overflow: hidden; }
        .legend span {
            display: inline-block; width: 12px; height: 12px; margin-right: 5px;
        }
        .tile-overlay {
            position: absolute; border: 2px solid red; pointer-events: none;
        }
        .toggle-button {
            margin-left: 5px; background: #3d85c6; color: white;
            border: none; padding: 8px; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <div style="display: flex; align-items: center; gap: 10px;">
        <img src="/assets/logo_santa_sofia.png" alt="Logo" style="height: 40px;">
        <strong>Lista de trabajo ‚ñ∏ {{slide}}</strong>
    </div>
    <div>
        <span style="margin-right: 15px;">{{usuario}}</span>
        <a href="/dashboard" style="color: white; text-decoration: none;">‚Üê Volver</a>
        <button id="toggle-view-btn" onclick="toggleVista()">üóÇ Ver tiles clasificados</button>
    </div>
</header>

<div class="main-container">
    <div class="left-panel">
        <h3>Conteo por clase</h3>
        <table><tbody id="tabla-clases"></tbody></table>
        <h4>Leyenda:</h4>
        <div class="legend" id="leyenda"></div>
    </div>

    <div id="openseadragon1" style="height: 90vh; flex-grow: 1;"></div>
<div style="margin-bottom: 10px;">
    <label for="tamano-tiles">Tama√±o:</label>
    <select id="tamano-tiles" onchange="actualizarTamanoTiles()">
        <option value="64">Peque√±o</option>
        <option value="128" selected>Mediano</option>
        <option value="256">Grande</option>
    </select>
</div>
    <div id="galeria-clasificada" style="display: none; padding: 20px; flex-grow: 1;">
        <h3>Tiles clasificados por categor√≠a</h3>
        <select id="clase-selector" onchange="mostrarGaleria(this.value)">
            <option value="">Selecciona una clase</option>
        </select>
        <div id="galeria" style="display:none; flex-wrap:wrap;"></div>
        <div id="paginacion" style="margin-top: 10px;"></div>
    </div>

    <div><button class="toggle-button" onclick="togglePanel()">‚ù∞</button></div>

    <div class="right-panel" id="panel-derecho">
        <h3>Datos del paciente</h3>
        <input type="text" id="nombre" placeholder="Nombre completo">
        <input type="number" id="edad" placeholder="Edad">
        <h4>Diagn√≥stico</h4>
        <textarea id="diagnostico" rows="4" placeholder="Escribe el diagn√≥stico..."></textarea>
        <h4>Comentarios</h4>
        <textarea id="comentarios" rows="4" placeholder="Notas adicionales..."></textarea>
        <button onclick="guardar()">üíæ Guardar reporte</button>
        <button onclick="finalizar()">‚úÖ Finalizar caso</button>
        <button onclick="window.location.href='/descargar_pdf?slide={{slide}}'">üìÑ Descargar PDF</button>
        <p id="mensaje" style="color:green; font-size:13px;"></p>
    </div>
</div>

<script>
const CONF_THRESHOLD = 0.0;
const TILE_SIZE = 256;
const SOURCE_LEVEL = 16;
const CLASS_COLORS = {
    "Normal": "#27ae60",
    "ASCUS": "#f39c12",
    "LSIL": "#e67e22",
    "HSIL": "#c0392b",
    "Carcinoma": "#8e44ad",
    "Artefacto": "#7f8c8d",
    "Desconocida": "#000000"
};

const viewer = OpenSeadragon({
    id: "openseadragon1",
    prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.0.0/images/",
    tileSources: `/static/{{slide}}.dzi`
});

let overlaysActivos = [];

function limpiarOverlays() {
    overlaysActivos.forEach(el => viewer.removeOverlay(el));
    overlaysActivos = [];
}

function mostrarOverlays(clase, datos) {
    limpiarOverlays();
    const color = CLASS_COLORS[clase] || "#000";
    const scale = Math.pow(2, viewer.source.maxLevel - SOURCE_LEVEL);

    datos.forEach(obj => {
        if (obj.confidence >= CONF_THRESHOLD) {
            const el = document.createElement("div");
            el.className = "tile-overlay";
            el.style.borderColor = color;
            el.style.width = `${TILE_SIZE}px`;
            el.style.height = `${TILE_SIZE}px`;

            const x = obj.x * scale;
            const y = obj.y * scale;
            const rect = viewer.viewport.imageToViewportRectangle(x, y, TILE_SIZE, TILE_SIZE);
            viewer.addOverlay({ element: el, location: rect });
            overlaysActivos.push(el);
        }
    });
}

function togglePanel() {
    const panel = document.getElementById("panel-derecho");
    const button = document.querySelector(".toggle-button");
    panel.classList.toggle("collapsed");
    button.innerText = panel.classList.contains("collapsed") ? "‚ù∞" : "‚ù±";
}

// Datos y leyenda
fetch(`/static/{{slide}}_predicciones.json`)
    .then(res => res.json())
    .then(data => {
        const tbody = document.getElementById("tabla-clases");
        const leyenda = document.getElementById("leyenda");
        const selector = document.getElementById("clase-selector");

        Object.entries(data).forEach(([clase, lista]) => {
            const row = document.createElement("tr");
            row.innerHTML = `<td><a href="#" onclick='mostrarOverlays("${clase}", ${JSON.stringify(lista)})'>${clase}</a></td><td>${lista.length}</td>`;
            tbody.appendChild(row);

            const color = CLASS_COLORS[clase] || "#000";
            leyenda.innerHTML += `<div><span style="background:${color};"></span> ${clase}</div>`;

            const option = document.createElement("option");
            option.value = clase;
            option.textContent = clase;
            selector.appendChild(option);
        });
    });

// Reporte
fetch("/leer_reporte?slide={{slide}}")
    .then(res => res.json())
    .then(data => {
        if (data.paciente) document.getElementById("nombre").value = data.paciente;
        if (data.edad) document.getElementById("edad").value = data.edad;
        if (data.diagnostico) document.getElementById("diagnostico").value = data.diagnostico;
        if (data.comentarios) document.getElementById("comentarios").value = data.comentarios;
    });

function guardar() {
    const data = {
        caso: "{{slide}}",
        usuario: "{{usuario}}",
        paciente: document.getElementById("nombre").value,
        edad: document.getElementById("edad").value,
        diagnostico: document.getElementById("diagnostico").value,
        comentarios: document.getElementById("comentarios").value,
        timestamp: new Date().toISOString()
    };
    fetch("/guardar_reporte", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    }).then(res => res.json()).then(res => {
        document.getElementById("mensaje").innerText = "‚úî Reporte guardado como " + res.archivo;
    });
}

function finalizar() {
    fetch("/finalizar_caso", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ caso: "{{slide}}" })
    }).then(res => res.json()).then(data => {
        if (data.status === "ok") alert("Caso marcado como cerrado.");
    });
}

// Alternancia entre vistas
let modoClasificado = false;
function toggleVista() {
    modoClasificado = !modoClasificado;
    document.getElementById("openseadragon1").style.display = modoClasificado ? "none" : "block";
    document.getElementById("galeria-clasificada").style.display = modoClasificado ? "block" : "none";
    document.getElementById("toggle-view-btn").innerText = modoClasificado ? "üîç Ver WSI original" : "üóÇ Ver tiles clasificados";

    if (modoClasificado) {
        document.getElementById("galeria").innerHTML = "";
        document.getElementById("paginacion").innerHTML = "";
    }
}

// Galer√≠a paginada
let paginaActual = 0;
const LIMITE = 20;
let claseSeleccionada = "";

function mostrarGaleria(clase) {
    claseSeleccionada = clase;
    paginaActual = 0;
    cargarPagina();
}

function cargarPagina() {
    const slide = "{{slide}}";
    const offset = paginaActual * LIMITE;
    const size = document.getElementById("tamano-tiles").value;

    fetch(`/listar_tiles?slide=${slide}&clase=${claseSeleccionada}&offset=${offset}&limit=${LIMITE}`)
        .then(res => res.json())
        .then(data => {
            const contenedor = document.getElementById("galeria");
            contenedor.style.display = "flex";
            contenedor.innerHTML = "";

            data.imagenes.forEach(url => {
                const img = document.createElement("img");
                img.src = url;
                img.style.width = `${size}px`;
                img.style.margin = "5px";
                contenedor.appendChild(img);
            });

            document.getElementById("paginacion").innerHTML = `
                <button onclick="paginaAnterior()">‚¨Ö</button>
                <button onclick="paginaSiguiente()">‚û°</button>
            `;
        });
}
function actualizarTamanoTiles() {
    cargarPagina();  // vuelve a renderizar con nuevo tama√±o
}
function paginaSiguiente() {
    paginaActual++;
    cargarPagina();
}

function paginaAnterior() {
    if (paginaActual > 0) {
        paginaActual--;
        cargarPagina();
    }
}
</script>

</body>
</html>
